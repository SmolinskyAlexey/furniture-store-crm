class CatalogWizard {    constructor() {        this.isLoading = false;        // Пагинация        this.cardsPerPage = 5;        this.currentProductsPage = 1;        this.state = {};        this.cache = {};        this.init();        //this.filter.type_show = "all_products";    }    async init() {        const ordersPage = document.getElementById("catalogPage");        if (!ordersPage) {return;}        try {            await this.preloadData();            this.state.initialized = true;            this.initializeFilters();            this.attachSearchListeners();            this.productsPagination();        } catch (error) {            console.error("Ошибка инициализации CatalogWizard:", error);            this.showError("Ошибка загрузки данных");        }    }	    async preloadData() {		        this.showLoading(true);		        try {            let products;            if ( !this.state.searchProduct && (!this.state.currentCategory || this.state.currentCategory == 'all') && !this.state.warehouse && !this.state.inStock ) {                [products] = await Promise.all([                    window.queries.getProducts((this.currentProductsPage-1) * this.cardsPerPage, this.cardsPerPage, 'all_products'),                ]);                this.cache.products = products;            }			else {				//если есть что-то в поиске                console.log(this.state.warehouse,"this.state.warehouse");                products = await window.queries.searchProductsQuery(                    this.state.currentCategory,                    this.state.searchProduct,                    (this.currentProductsPage - 1) * this.cardsPerPage,                    this.cardsPerPage,                    {warehouse_id: this.state.warehouse, inStock: this.state.inStock}                );                this.cache.searchedProducts = products;            }            this.mountCatalog(products);        } finally {            this.showLoading(false);        }		    }    mountCatalog(products) {		        const html       = window.CatalogTemplates.renderCatalog(products.list, products.allow_edit);        const table      = document.querySelector(".default-table tbody");        const totalLabel = document.querySelector(".total-count");		        // Монтируем список продуктов        table.innerHTML = html;		        // Монтируем количество продуктов        totalLabel.innerHTML = `Всего ${products.total_num}&nbsp;товаров`;        		this.productsPagination();		    }    initializeFilters() {        document.querySelectorAll('.filter-tab').forEach(tab => {            tab.addEventListener('click', () => {                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));                tab.classList.add('active');                const category = tab.getAttribute('data-category');                this.state.currentCategory = category;                this.currentProductsPage = 1;                this.preloadData();            });        });        let whFilter = document.querySelector("#select-warehouse");        whFilter.addEventListener('change', () => {//при выборе select            this.state.warehouse = whFilter.value;            this.currentProductsPage = 1;            this.preloadData();        });        let categoryFilter = document.querySelector("#select-category");        categoryFilter.addEventListener('change', () => {//при выборе select            this.state.currentCategory = categoryFilter.value;            this.currentProductsPage = 1;            this.preloadData();        });        let inStockFilter = document.querySelector("#in-stock");        inStockFilter.addEventListener('click', () => {//при выборе select            this.state.inStock = inStockFilter.checked;            this.currentProductsPage = 1;            this.preloadData();        });        }    showLoading(show) {		        this.isLoading = show;        const spinner    = document.getElementById("loadingSpinner");        const modalBody  = document.getElementById("modalBody");        const tableTbody = document.querySelector(".table__wrapper tbody");        if (spinner && modalBody) {            if (show) {                spinner.style.display = "flex";                modalBody.style.opacity = "1";                tableTbody.innerHTML = "...";                tableTbody.style.display = "none";            }			else {                spinner.style.display = "none";                modalBody.style.opacity = "1";                tableTbody.style.display = "block";            }        }    }    attachSearchListeners() {        const root = document.querySelector('.search-bar');        const searchUI = {            root,            input: root.querySelector('.search-input'),            clearBtn: root.querySelector('.clear-btn'),            searchBtn: root.querySelector('.search-btn'),        };        // Слушатель поля ввода        searchUI.input.addEventListener('input', () => {            searchUI.clearBtn.style.display = searchUI.input.value ? 'block' : 'none';            if (!searchUI.input.value) {                this.cache.searchedProducts = undefined;                this.state.searchProduct = "";                this.mountCatalog(this.cache.products);            }        });        // Cлушатель на кнопку очистки        searchUI.clearBtn.addEventListener('click', () => {            searchUI.input.value = '';            searchUI.clearBtn.style.display = 'none';            searchUI.input.focus();            this.cache.searchedProducts = undefined;            this.state.searchProduct = "";            this.mountCatalog(this.cache.products);        });        if (this.cache.searchedProducts || this.state.searchProduct) {            searchUI.clearBtn.style.display = 'block';        }        const handleSearch = async () => {            if (!searchUI.input.value) {return;}            this.currentProductsPage = 1;            this.mountCatalog(this.cache.products);            const response = await window.queries.searchProductsQuery(                this.state.currentCategory,                this.state.searchProduct,                (this.currentProductsPage - 1) * this.cardsPerPage,                this.cardsPerPage,                {warehouse_id: this.state.warehouse, inStock: this.state.inStock}            );            this.cache.searchedProducts = response?.list?.length ? response?.list : [];             this.state.searchProduct = searchUI.input.value;             this.preloadData();        };        // Cлушатель на кнопку поиска        searchUI.searchBtn.addEventListener('click', handleSearch);        // Cлушатель на Enter        window.addEventListener("keydown", (e)=> {            if (e.key === "Enter" && document.activeElement === searchUI.input) handleSearch();        });    }    productsPagination() {        const paginationContainer = document.querySelector(".table-pagination");        const prevBtn = paginationContainer.querySelector(".prev-arrow");        const nextBtn = paginationContainer.querySelector(".next-arrow");        const pageIndicator = paginationContainer.querySelector('.page-indicator');        const totalProducts = this.cache?.searchedProducts?.total_num || this.cache?.products?.total_num;        const totalPages = Math.ceil(totalProducts / this.cardsPerPage);               // Очищение слушателей        const prev = prevBtn.cloneNode(true);        prevBtn.parentNode.replaceChild(prev, prevBtn);        prev.addEventListener("click", () => {                if (this.currentProductsPage > 1) {                    this.currentProductsPage = this.currentProductsPage - 1;                     this.preloadData();                }            });        // Очищение слушателей        const next = nextBtn.cloneNode(true);        nextBtn.parentNode.replaceChild(next, nextBtn);        next.addEventListener("click", () => {                if (this.currentProductsPage < totalPages) {                    this.currentProductsPage = this.currentProductsPage + 1;                    this.preloadData();                }            });        pageIndicator.innerHTML = `стр ${this.currentProductsPage}&nbsp;из ${totalPages}`;        if (totalPages === 0) {            paginationContainer.classList.add("hidden");        }		else {            paginationContainer.classList.remove("hidden");        }    }}// Глобальная инициализацияwindow.CatalogWizard = CatalogWizard;